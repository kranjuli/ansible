name: Build and Release Ansible Collections

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name:  🏗 Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: 🏗 Install ansible and dependencies
      run: |
        pip install ansible

    - name: 🏗 Build Ansible Collections
      run: |
        find . -type f -name galaxy.yml | while read galaxy; do
          dir=$(dirname "$galaxy")
          echo "Building collection in $dir"
          cd "$dir"
          ansible-galaxy collection build
          cd - > /dev/null
        done

    - name: Collect all collection tarballs
      run: |
        find . -name ".tar.gz" > artifacts.txt

    - name: Create release with all collections
      uses: softprops/action-gh-release@v1
      with:
        files: |
          $(cat artifacts.txt)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}